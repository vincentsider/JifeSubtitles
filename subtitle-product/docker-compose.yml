# =============================================================================
# JIFE Subtitle System - Docker Compose
# =============================================================================
# Single service using faster-whisper with large-v3 as default.
#
# Usage:
#   Start:   docker compose up -d
#   Stop:    docker compose down
#   Logs:    docker logs subtitle-server
# =============================================================================

services:
  subtitle-server:
    # Custom built image with faster-whisper + CTranslate2 CUDA
    image: jife-faster-whisper:latest
    build:
      context: .
      dockerfile: Dockerfile.faster-whisper

    container_name: subtitle-server

    working_dir: /app
    command: ["python3", "/app/app/main.py"]

    # Enable NVIDIA runtime for GPU access
    runtime: nvidia

    # Restart policy
    restart: unless-stopped

    # Audio device access
    devices:
      - /dev/snd:/dev/snd

    # Required for ALSA
    group_add:
      - audio

    # Environment variables
    # Default: large-v3 with INT8 + beam_size=1 (best accuracy)
    environment:
      - AUDIO_DEVICE=${AUDIO_DEVICE:-plughw:2,0}
      - WHISPER_MODEL=${WHISPER_MODEL:-large-v3}
      - WHISPER_BACKEND=${WHISPER_BACKEND:-faster_whisper}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}
      - WHISPER_BEAM_SIZE=${WHISPER_BEAM_SIZE:-1}
      - WEB_PORT=5000
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    # Port mapping
    ports:
      - "5000:5000"

    # Volume mounts
    volumes:
      # Mount application code
      - .:/app
      # Mount JIFE directory for test audio
      - /home/vincent/JIFE:/data
      # Persist faster-whisper model cache
      - faster_whisper_cache:/root/.cache/huggingface
      # Logs (optional)
      - ./logs:/var/log/subtitle-server
      # Power control FIFO for safe shutdown/reboot
      - /tmp/jife-power-control:/tmp/jife-power-control

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 7G
        reservations:
          memory: 5G

volumes:
  faster_whisper_cache:
    driver: local
